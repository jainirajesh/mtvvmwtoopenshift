---
- name: Create WARM migration plans from CSV
  hosts: localhost
  gather_facts: false

  vars_files:
    - vars.yaml

  tasks:
    - name: Read CSV content (base64)
      slurp:
        src: vm_list_to_migrate.csv
      register: raw_csv

    - name: Decode and split CSV into lines
      set_fact:
        csv_lines: "{{ raw_csv.content | b64decode | regex_findall('.*') }}"

    - name: Extract CSV headers
      set_fact:
        csv_headers: "{{ csv_lines[0].split(',') | map('trim') | list }}"

    - name: Parse each row into a dictionary
      set_fact:
        all_rows: "{{ all_rows | default([]) + [dict(csv_headers | zip(row.split(',') | map('trim') | list))] }}"
      loop: "{{ csv_lines[1:] }}"
      loop_control:
        loop_var: row
      when: row.strip() != ''

    - name: Filter only warm rows
      set_fact:
        warm_rows: "{{ all_rows | selectattr('Cold or Warm', 'equalto', 'warm') | list }}"

    - name: Group warm VMs by Plan Name
      set_fact:
        warm_plans_dict: "{{ warm_rows | groupby('Plan Name') | items2dict(key_name=0, value_name=1) }}"

    - name: Format warm plans structure with vms and rows
      set_fact:
        plans_with_vms: >-
          {{
            warm_plans_dict
            | dict2items
            | map('combine', {
                'key': item.key,
                'value': {
                  'rows': item.value,
                  'vms': item.value
                         | map('extract', ['RHOS Name', 'VM ID'])
                         | map('community.general.dict_kv', 'name', 'id')
                         | list,
                  'is_warm': true
                }
              })
            | list
          }}

    - name: Loop over each warm plan group and create them
      include_tasks: create_single_plan.yaml
      loop: "{{ plans_with_vms }}"
      loop_control:
        loop_var: plan_group
