---
- name: VM Migration Plan with multicolumn CSV input
  hosts: localhost
  gather_facts: false

  vars_files:
    - vars.yaml

  tasks:

    - name: Load raw CSV file
      ansible.builtin.slurp:
        src: migration_plan.csv
      register: raw_csv

    - name: Debug raw CSV content (decoded)
      debug:
        msg: "{{ raw_csv.content | b64decode }}"

    - name: Decode CSV lines and remove empty lines
      ansible.builtin.set_fact:
        csv_lines: "{{ (raw_csv.content | b64decode).splitlines() | reject('equalto', '') | list }}"

    - name: Debug CSV lines
      debug:
        var: csv_lines

    - name: Extract header and VM data rows
      ansible.builtin.set_fact:
        csv_header: "{{ csv_lines[0].split(',') | map('trim') | list }}"
        csv_rows: "{{ csv_lines[1:] }}"

    - name: Debug csv_header and csv_rows first line
      debug:
        msg:
          header: "{{ csv_header }}"
          first_row: "{{ csv_rows[0] if csv_rows else 'no rows' }}"

    - name: Convert each CSV row to a dictionary preserving order
      ansible.builtin.set_fact:
        parsed_csv: >-
          {% set result = [] %}
          {% for row in csv_rows %}
            {% set values = row.split(',') %}
            {% set item = {} %}
            {% for i in range(csv_header | length) %}
              {% set key = csv_header[i] %}
              {% set val = values[i] if i < (values | length) else '' %}
              {% set _ = item.update({key: val | trim}) %}
            {% endfor %}
            {% set result = result + [item] %}
          {% endfor %}
          {{ result }}

    - name: Debug structured VM data
      ansible.builtin.debug:
        var: parsed_csv

    - name: Build Forklift VM list from "RHOS Name" column
      ansible.builtin.set_fact:
        vm_list: "{{ parsed_csv | map('extract', attribute='RHOS Name') | map('regex_replace', '^(.+)$', '{\"name\":\"\\1\"}') | map('from_json') | list }}"

    - name: Debug VM list for migration plan
      ansible.builtin.debug:
        var: vm_list

    - name: Create Forklift Migration Plan
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: Plan
          metadata:
            name: "{{ plan_name }}"
            namespace: "{{ mtv_namespace }}"
          spec:
            provider:
              source:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ source_provider_name }}"
                namespace: "{{ mtv_namespace }}"
              destination:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ destination_provider_name }}"
                namespace: "{{ mtv_namespace }}"
            map:
              network:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: NetworkMap
                name: "{{ network_map_name }}-{{ plan_name }}"
                namespace: "{{ mtv_namespace }}"
              storage:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: StorageMap
                name: "{{ storage_map_name }}-{{ plan_name }}"
                namespace: "{{ mtv_namespace }}"
            namespace: "{{ mtv_namespace }}"
            targetNamespace: "{{ mtv_namespace }}"
            vms: "{{ vm_list }}"
            warm: true
            preserveStaticIPs: true

    - name: Get Plan UID
      kubernetes.core.k8s_info:
        api_version: forklift.konveyor.io/v1beta1
        kind: Plan
        name: "{{ plan_name }}"
        namespace: "{{ mtv_namespace }}"
      register: plan_info

    - name: Set Plan UID
      ansible.builtin.set_fact:
        plan_uid: "{{ plan_info.resources[0].metadata.uid }}"

    - name: Create NetworkMap with owner reference
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: NetworkMap
          metadata:
            name: "{{ network_map_name }}-{{ plan_name }}"
            namespace: "{{ mtv_namespace }}"
            ownerReferences:
              - apiVersion: forklift.konveyor.io/v1beta1
                kind: Plan
                name: "{{ plan_name }}"
                uid: "{{ plan_uid }}"
                controller: true
                blockOwnerDeletion: true
          spec:
            provider:
              source:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ source_provider_name }}"
                namespace: "{{ mtv_namespace }}"
              destination:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ destination_provider_name }}"
                namespace: "{{ mtv_namespace }}"
            map:
              - source:
                  type: vmware
                  name: "{{ parsed_csv[0]['Source Network'] }}"
                destination:
                  type: multus
                  name: "{{ parsed_csv[0]['Target Network'] }}"
                  namespace: "{{ target_network_namespace }}"

    - name: Create StorageMap with owner reference
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: forklift.konveyor.io/v1beta1
          kind: StorageMap
          metadata:
            name: "{{ storage_map_name }}-{{ plan_name }}"
            namespace: "{{ mtv_namespace }}"
            ownerReferences:
              - apiVersion: forklift.konveyor.io/v1beta1
                kind: Plan
                name: "{{ plan_name }}"
                uid: "{{ plan_uid }}"
                controller: true
                blockOwnerDeletion: true
          spec:
            provider:
              source:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ source_provider_name }}"
                namespace: "{{ mtv_namespace }}"
              destination:
                apiVersion: forklift.konveyor.io/v1beta1
                kind: Provider
                name: "{{ destination_provider_name }}"
                namespace: "{{ mtv_namespace }}"
            map:
              - source:
                  type: vmware
                  name: "{{ parsed_csv[0]['Source Datastore'] }}"
                destination:
                  storageClass: "{{ parsed_csv[0]['Target StorageClass'] }}"
