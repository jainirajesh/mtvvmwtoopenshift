- name: Debug cutover time string before conversion for {{ plan_name }}
  debug:
    msg: "cutover_time_str='{{ cutover_time_str }}'"

- name: Convert cutover time string to epoch and calculate timeout
  set_fact:
    plan_cutover_epoch: "{{ (cutover_time_str | strptime('%Y-%m-%d %H:%M:%S')).timestamp() | int }}"
    current_epoch: "{{ lookup('pipe', 'date -u +%s') | int }}"
    timeout_seconds: "{{ plan_cutover_epoch - current_epoch }}"

- name: Wait until cutover time for {{ plan_name }} (if needed)
  wait_for:
    timeout: "{{ timeout_seconds }}"
  when:
    - timeout_seconds is defined
    - timeout_seconds > 0

- name: Cutover plan {{ plan_name }}
  include_tasks: include/03_2_patch_cutover_task.yml
  vars:
    plan_name: "{{ plan_name }}"
    mtv_namespace: "{{ mtv_namespace }}"
  when: plan_name is defined
