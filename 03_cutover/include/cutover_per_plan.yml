- name: Normalize cutover time string for {{ plan_name }}
  set_fact:
    cutover_time_iso: "{{ cutover_time_str.replace(' ', 'T') + 'Z' }}"

- name: Convert cutover_time to epoch (UTC) for {{ plan_name }}
  set_fact:
    plan_cutover_epoch: "{{ (cutover_time_iso | to_datetime('%Y-%m-%dT%H:%M:%SZ')).timestamp() | int }}"
    current_epoch: "{{ now('utc').timestamp() | int }}"
    timeout_seconds: "{{ plan_cutover_epoch - current_epoch }}"

- name: Debug timing for {{ plan_name }}
  debug:
    msg:
      - "Cutover time (ISO): {{ cutover_time_iso }}"
      - "Cutover epoch: {{ plan_cutover_epoch }}"
      - "Current epoch: {{ current_epoch }}"
      - "Timeout seconds: {{ timeout_seconds }}"

- name: Wait until cutover time for {{ plan_name }} (if needed)
  wait_for:
    timeout: "{{ timeout_seconds }}"
  when:
    - timeout_seconds is defined
    - timeout_seconds > 0

- name: Cutover plan {{ plan_name }}
  include_tasks: include/03_2_patch_cutover_task.yml
  vars:
    plan_name: "{{ plan_name }}"
    mtv_namespace: "{{ mtv_namespace }}"
  when: plan_name is defined
