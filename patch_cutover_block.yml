---
- name: Find all migrations matching Plan {{ plan_name }}
  set_fact:
    matching_migrations: >-
      {{
        all_migrations.resources
        | selectattr('spec.plan.name', 'equalto', plan_name)
        | sort(attribute='metadata.creationTimestamp', reverse=True)
      }}

- name: Set latest migration for Plan {{ plan_name }}
  set_fact:
    latest_migration: "{{ matching_migrations[0] }}"
  when: matching_migrations | length > 0

- name: Fail if no migration found for Plan {{ plan_name }}
  fail:
    msg: "No migration found for plan {{ plan_name }}"
  when: matching_migrations | length == 0

- name: Patch migration {{ latest_migration.metadata.name }} with cutover time
  kubernetes.core.k8s_json_patch:
    kind: Migration
    api_version: forklift.konveyor.io/v1beta1
    name: "{{ latest_migration.metadata.name }}"
    namespace: "{{ mtv_namespace }}"
    patch:
      - op: add
        path: /spec/cutover
        value: "{{ cutover_time }}"

- name: Show success message for Plan {{ plan_name }}
  debug:
    msg: "âœ… Cutover applied to migration '{{ latest_migration.metadata.name }}' for plan '{{ plan_name }}'"
