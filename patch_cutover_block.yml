---
- name: Set matching migrations for {{ plan_name }}
  set_fact:
    matching_migrations: >-
      {{
        all_migrations.resources
        | selectattr('spec.plan.name', 'equalto', plan_name)
        | sort(attribute='metadata.creationTimestamp', reverse=True)
      }}

- name: Check if matching migration exists for {{ plan_name }}
  fail:
    msg: "❌ No migration found for plan '{{ plan_name }}'. Please check if sync has been run."
  when: matching_migrations | length == 0

- name: Set latest migration object for {{ plan_name }}
  set_fact:
    latest_migration: "{{ matching_migrations[0] }}"

- name: Wait for migration to reach CopyingPaused
  kubernetes.core.k8s_info:
    api_version: forklift.konveyor.io/v1beta1
    kind: Migration
    namespace: "{{ mtv_namespace }}"
    name: "{{ latest_migration.metadata.name }}"
  register: latest_migration_status
  retries: 10
  delay: 5
  until: >-
    (
      latest_migration_status.resources | map(attribute='status') | map(attribute='migration') | select('defined')
      | map(attribute='vms') | flatten
      | selectattr('phase', 'equalto', 'CopyingPaused')
      | list | length
    ) > 0
  when: latest_migration is defined

- name: Patch cutover time on latest migration {{ latest_migration.metadata.name }}
  kubernetes.core.k8s_json_patch:
    kind: Migration
    api_version: forklift.konveyor.io/v1beta1
    name: "{{ latest_migration.metadata.name }}"
    namespace: "{{ mtv_namespace }}"
    patch:
      - op: add
        path: /spec/cutover
        value: "{{ cutover_time }}"

- name: ✅ Patched cutover on migration for {{ plan_name }}
  debug:
    msg: "Cutover patch applied on Migration '{{ latest_migration.metadata.name }}' for Plan '{{ plan_name }}'"
