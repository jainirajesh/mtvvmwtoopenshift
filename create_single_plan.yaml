- name: Create NetworkMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: forklift.konveyor.io/v1beta1
      kind: NetworkMap
      metadata:
        name: "netmap-{{ plan_group.key | lower }}"
        namespace: "{{ mtv_namespace }}"
      spec:
        provider:
          source:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ source_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ source_provider_uid }}"
          destination:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ destination_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ destination_provider_uid }}"
        map:
          - source:
              id: "{{ source_networkmap_id }}"
            destination:
              name: "{{ target_networkmap }}"
              namespace: "{{ target_network_namespace }}"
              type: multus

- name: Create StorageMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: forklift.konveyor.io/v1beta1
      kind: StorageMap
      metadata:
        name: "storagemap-{{ plan_group.key | lower }}"
        namespace: "{{ mtv_namespace }}"
      spec:
        provider:
          source:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ source_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ source_provider_uid }}"
          destination:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ destination_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ destination_provider_uid }}"
        map:
          - source:
              id: "{{ source_storagemap_id }}"
            destination:
              storageClass: "{{ target_storage }}"

- name: Create Migration Plan
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: forklift.konveyor.io/v1beta1
      kind: Plan
      metadata:
        name: "{{ plan_group.key }}"
        namespace: "{{ mtv_namespace }}"
      spec:
        provider:
          source:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ source_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ source_provider_uid }}"
          destination:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: Provider
            name: "{{ destination_provider_name }}"
            namespace: "{{ mtv_namespace }}"
            uid: "{{ destination_provider_uid }}"
        map:
          network:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: NetworkMap
            name: "netmap-{{ plan_group.key | lower }}"
            namespace: "{{ mtv_namespace }}"
          storage:
            apiVersion: forklift.konveyor.io/v1beta1
            kind: StorageMap
            name: "storagemap-{{ plan_group.key | lower }}"
            namespace: "{{ mtv_namespace }}"
        targetNamespace: "{{ plan_group.value.rows[0]['Target Namespace'] }}"
        pvcNameTemplateUseGenerateName: true
        preserveStaticIPs: true
        migrateSharedDisks: true
        warm: true
        vms: "{{ plan_group.value.vms }}"
